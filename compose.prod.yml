services:
  database:
    image: postgis/postgis:13-master
    container_name: ${PROJECT_NAME}__database
    platform: linux/amd64

    ports:
      - ${DB_PORT}:${DB_PORT}
    expose:
      - ${DB_PORT}
    command: -p ${DB_PORT}

    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PWD}

    volumes:
      - ./postgres/data/database:/var/lib/postgresql/data

  directus:
    image: ${PROJECT_NAME}__directus
    container_name: ${PROJECT_NAME}__directus

    build:
      context: ./directus
      dockerfile: ./Dockerfile

    ports:
      - ${DIRECTUS_PORT}:${DIRECTUS_PORT}

    depends_on:
      - database

    environment:
      NODE_ENV: production
      PROJECT_NAME: ${PROJECT_NAME}
      TEMPLATE_DIR: ${TEMPLATE_DIR}
      SECRET: ${SECRET}
      PUBLIC_URL: ${DIRECTUS_URL}
      PORT: ${DIRECTUS_PORT}
      DB_CLIENT: "pg"
      DB_HOST: "database"
      DB_PORT: ${DB_PORT}
      DB_DATABASE: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PWD}
      CACHE_ENABLED: "false"
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PWD}
      DIRECTUS_ADMIN_TOKEN: ${DIRECTUS_ADMIN_TOKEN}
      CONTENT_SECURITY_POLICY_DIRECTIVES__FRAME_ANCESTORS: array:http://localhost:*,TODO,self
      CONTENT_SECURITY_POLICY_DIRECTIVES__CHILD_SRC: array:http://localhost:*,TODO,self
      MARKETPLACE_TRUST: all
      CORS_ENABLED: "true"
      CORS_ORIGIN: "*"

    volumes:
      - ./directus/uploads:/directus/uploads
      - ./directus/extensions:/directus/extensions
      - ./directus/templates:/directus/templates
      - ./directus/backups:/directus/backups
      - ./directus/backup.sh:/directus/backup.sh
      - ./directus/restore.sh:/directus/restore.sh
      - ./directus/template.sh:/directus/template.sh

    labels:
      # traefik with coolify needs harcoded Directus port :
      - traefik.http.services.directus.loadbalancer.server.port=8058

  nuxt:
    image: ${PROJECT_NAME}__nuxt
    container_name: ${PROJECT_NAME}__nuxt

    build:
      context: ./nuxt
      dockerfile: ./Dockerfile.prod
      # Env variables required for build time needs to be passed as args in compose and dockerfile
      args:
        NUXT_URL: ${NUXT_URL}
        DIRECTUS_URL: ${DIRECTUS_URL}
        DIRECTUS_ADMIN_TOKEN: ${DIRECTUS_ADMIN_TOKEN}
        NUXT_PUBLIC_UMAMI_HOST: ${NUXT_PUBLIC_UMAMI_HOST}
        NUXT_PUBLIC_UMAMI_ID: ${NUXT_PUBLIC_UMAMI_ID}

    tmpfs: /tmp

    ports:
      - ${NUXT_PORT}:${NUXT_PORT}

    depends_on:
      - directus

    environment:
      NUXT_URL: ${NUXT_URL}
      PORT: ${NUXT_PORT}
      DIRECTUS_URL: ${DIRECTUS_URL}
      DIRECTUS_ADMIN_TOKEN: ${DIRECTUS_ADMIN_TOKEN}
